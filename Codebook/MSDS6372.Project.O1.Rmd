---
title: "MSDS 6372 Project 1 Objective 1"
author: "Jaclyn A Coate"
date: "2/5/2020"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r libraries}
library(tidyverse)
library(mice)
library(skimr)
library(corrplot)
library(car)
library(ISLR)
library(ggplot2)
library(gridExtra)
library(SamplingStrata)
library(rbin)
library(leaps)
```

# Objective 1:
## Question of Interest: what variables are used to predict price of a NYC Airbnb

```{r data prep}
nycraw <- read.csv("https://raw.githubusercontent.com/JaclynCoate/6372_Project_1/master/AB_NYC_2019.csv", header = TRUE, strip.white=TRUE)
head(nycraw)
str(nycraw)
```

## EDA to determine type of multiple linear regression to perform

#### Removing logically irrelevant variables

```{r drop irrelevant variables}
#Dropping logical irrelevant variables: "id", "name", "host_id", "host_name", "last_reiview", "latitude", "longitude", "neighborhood","availability_365"
nyc2 <- select(nycraw, -c("id", "name", "host_id", "host_name", "last_review", "latitude", "longitude", "neighbourhood","availability_365"))
head(nyc2)
```

#### Dependent Variable Check
- Checking on dependent variable range to make sure if there are zero's to remove. It would not be free to stay in NYC.
```{r}
nyc2 <- nyc2[!(nyc2$price==0),]
invisible(view(nyc2))
```

#### NA Evaluation and Drop

```{r NA eval}
#Checking for NAs
md.pattern(nyc2)
nrow(nyc2)
#Drop NAs that are present
nyc3 <- na.omit(nyc2)
#Confirming NA drop
nrow(nyc3)
```

#### Zero variance variable check - all show variance so remain in model

```{r zero variable check}
#Results show no zero variance variables, leave in all
skim(nyc3)
```

#### Storing all categorical variables as factors

```{r categorical as factors}
#Storing categorical variables as factors
skim(nyc3)
```

#### Checking for Multicollinearity
- Multicollinearity will weaken the model
  - number_of_reviews and reviews_per_month are correlated at 55%
    - Removing reviews_per_month

```{r multicollinearity1}
corrNYC <- nyc3
#Table numeric variables
corrNYCTable <- corrNYC %>% keep(is.numeric) %>% cor %>% view
#Plot numeric variables v numeric variables
corrNYC %>% keep(is.numeric) %>% cor %>% corrplot("upper", addCoef.col = "white", number.digits = 2, number.cex = 0.5, method="square", order="hclust", tl.srt=45, tl.cex = 0.8)
invisible(view(corrNYCTable))
```

```{r attrition: removing highly correlated variable}
#Removing reviews_per_month due to high correlation of is and number_of_reviews
nyc4 <- select(nyc3, -c("reviews_per_month"))
```

#### Summary Review of Data Set

```{r summary of dataset}
summary(nyc4)
```

#### Removing outliers from minimum nights stay
- Anything over 365 is more than a year and would be improbable
- Removing any minimum nights metric over 365

```{r removeing outliers of nights stay}
nyc4 <- nyc4[!(nyc4$minimum_nights > 365),]
invisible(view(nyc4))
```

#### Examining VIFs
- The below results show us there is no need to remove any variables

```{r examining VIFs}
full.model<-lm(price~.,data=nyc4)  # . means all variable not mpg
vif(full.model)[,3]^2

alias(lm(price~.,data=nyc4))
```

#### Reviewing Linearity with Numeric Variables
- Curved relationships with the numeric variables
  - Could require a quadratic or logarithmic transformation

```{r linearity check}
#nyc4 %>% pairs() No color model
pairs(nyc4,col=nyc4$neighbourhood_group) #Color by neighborhood

par(mfrow=c(2,2))
plot(full.model)
```

#### Creating new Log price variable
- Based on the above plots we may benefit from a transformation
  - Log transforming price to create a log-linear regression

```{r create logged dependent variable}
log.nyc <- nyc4 %>% mutate(lprice=log(price))
log.nyc <- select(log.nyc, -c("price"))
invisible(log.nyc)
```

#### Examining VIFs of Log Price Variable

```{r exmaining log-linear VIFs}
log.depend.model<-lm(lprice~.,data=log.nyc)  # . means all variable not mpg
vif(log.depend.model)[,3]^2

alias(lm(lprice~.,data=log.nyc))
```

#### Reviewing Linearity with Independent and Logged Dependent (Price) Variable
- Curved relationships with the numeric variables
  - Could require a quadratic or logarithmic transformation

```{r linearity check of log-linear model}
pairs(log.nyc,col=log.nyc$neighbourhood_group)

par(mfrow=c(2,2))
plot(log.depend.model)
```

#### Log-log model
- Due to lack of linearity trying to transform the independent variables to see if we can surface a linear relationship

```{r created logged independent variables}
log.indep.nyc <- log.nyc %>% mutate(lreviews=log(number_of_reviews))
log.indep.nyc <- log.indep.nyc %>% mutate(lnights=log(minimum_nights))
log.indep.nyc <- log.indep.nyc %>% mutate(llistings=log(calculated_host_listings_count))
invisible(log.indep.nyc)

log.indep.nyc <- select(log.indep.nyc, -c("minimum_nights", "number_of_reviews", "calculated_host_listings_count"))
invisible(log.indep.nyc)
```

#### Examining VIFs of Log-Log Model

```{r examining log-log VIFs}
log.indep.model<-lm(lprice~.,data=log.indep.nyc)  # . means all variable not mpg
vif(log.indep.model)[,3]^2

alias(lm(lprice~.,data=log.indep.nyc))
```

#### Reviewing Linearity with Logged Independent and Dependent Variables
- Curved relationships with the numeric variables
  - Could require a quadratic or logarithmic transformation

```{r linearity check of log-log model}
pairs(log.indep.nyc,col=log.indep.nyc$neighbourhood_group) #Color by neighborhood

par(mfrow=c(2,2))
plot(log.indep.model)
```

#### Continuous Variable Manipulation
- Since we are seeing large clouds of data but no linear trend with logged and unlogged data, we are going to move forward with binning the data to see if it will assist us in determining if there is a relationship between the continuous variables and log price

```{r rbin}
nyc5 <- rbin_winsorize(nyc4, price, number_of_reviews, 50, winsor_rate = 0.05)
nyc5

nyc4 %>% keep(is.numeric) %>% pairs() #[Add color]

par(mfrow=c(2,2))
plot(full.model)
```

#### Continuous Variable Bin Manipulation
- Since we are seeing large clouds of data but no linear trend with logged and unlogged data, we are going to move forward with binning the data to see if it will assist us in determining if there is a relationship between the continuous variables and log price

```{r var.bin}
nyc.bins <- nyc4

nyc.bins$reviewsBin <- var.bin(nyc.bins$number_of_reviews, bins = 50)
nyc.bins$nightsBin <- var.bin(nyc.bins$minimum_nights, bins = 50)
nyc.bins$listBin <- var.bin(nyc.bins$calculated_host_listings_count, bins = 10)

nyc.bins <- select(nyc.bins,-c("minimum_nights", "number_of_reviews", "calculated_host_listings_count"))
invisible(nyc.bins)
```

#### Reviewing Linearity with Binned Indepedent Variables
- No linearity is presenting itself with a binned approach of the independent variables

```{r linearity check of binned independent variables}
nyc.bin.model <-lm(price~.,data=nyc.bins)
#nyc.bins  %>% pairs() No color model
pairs(nyc.bins,col=nyc.bins$neighbourhood_group) #Color by neighborhood

par(mfrow=c(2,2))
plot(nyc.bin.model)
```

#### Explore potential correlation Neighborhood v Price
- We have to this moment not be able to surface linearity relationships between our numerican independent varaibles and our dependt variable
- Next we will check for correltaion of the categorical variables: room_type & neighbourhood_group
- Without removing the ouliers of price above 400 it is near impossible to see if there is a difference per neighborhood. We have removed those prices above 400 to see if the 
- We see a strong chance of correlation between Price and Neighbourhood Group

```{r}
nyc.categorical <- nyc4[!(nyc4$price > 400),]
nrow(nyc4)
nrow(nyc.categorical)
plot(nyc.categorical$neighbourhood_group, nyc.categorical$price, xlab = "Neighbourhood Group", ylab = "Price", title = "Price v Neighbourhood Group Correlation Check", col=c(7,32,52,82,107)) 
```

#### Explore potential correlation Room Type v Price
- We see a strong chance of corerlation between Price and Room Type

```{r}
plot(nyc.categorical$room_type, nyc.categorical$price, xlab = "Room Type", ylab = "Price", title = "Price v Room Type Correlation Check", col=c(7,32,52)) 
```

#### Reviewing Linearity with Numeric Variables w/ Price > 400 Outliers Removed

```{r linearity check w Price greater than 400 Outliers Removed}
nyc.cat.model<-lm(price~.,data=nyc.categorical) 
#nyc4 %>% pairs() No color model
pairs(nyc.categorical,col=nyc.categorical$neighbourhood_group) #Color by neighborhood

par(mfrow=c(2,2))
plot(nyc.cat.model)
```

#### Reviewing Linearity with Numeric Variables w/ Log-Linear model Price > 400 Outliers Removed
- Still no obvious linearity

```{r linearity check w Log-Linear model Price greater than 400 Outliers Removed}
log.nyc.outliers <- log.nyc[!(log.nyc$lprice > 400),]

log.nyc.outliers.model<-lm(lprice~.,data=log.nyc.outliers) 
pairs(log.nyc.outliers, col=log.nyc.outliers$neighbourhood_group) #Color by neighborhood

par(mfrow=c(2,2))
plot(log.nyc.outliers.model)
```

#### Modeling
- We are not seeing any linear correlation between the dependent and independent numeric varaibles
- We are seeing a strong chance of linear correlation between the dependent and independent categorical variables
- We have surfaced the best residuals assumptions matched in a log-linear model
  - Due to this we are moving forward with modeling a log-linear model with singular variables as well as all interaction terms
  - This is to add complexity to our model, we have a low number of varaibles to select from
    - In adding this complexity we are tryign to surface any possible linear variable interations that may contribute to our model
    - If these are surfaced we will go back and use graphical means to verify the model's discovery

```{r full model check for p-value significance}
nyc.model = lm(lprice~neighbourhood_group + room_type + neighbourhood_group:room_type + minimum_nights + number_of_reviews + calculated_host_listings_count + minimum_nights:number_of_reviews + minimum_nights:calculated_host_listings_count + number_of_reviews:calculated_host_listings_count, data=log.nyc.outliers)
summary(nyc.model)
```

#### Model selection attempts

```{r forward selection model}
nyc.fwd = regsubsets(lprice~neighbourhood_group + room_type + neighbourhood_group:room_type + minimum_nights + number_of_reviews + calculated_host_listings_count + minimum_nights:number_of_reviews + minimum_nights:calculated_host_listings_count + number_of_reviews:calculated_host_listings_count, data=log.nyc.outliers, method="forward",nvmax=20)
summary(nyc.fwd)$adjr2
summary(nyc.fwd)$rss
summary(nyc.fwd)$bic
```

```{r forward selection model 2}
nyc.fwd2 = regsubsets(lprice~neighbourhood_group + room_type + neighbourhood_group:room_type + minimum_nights + number_of_reviews + calculated_host_listings_count, data=log.nyc.outliers, method="forward",nvmax=50)
summary(nyc.fwd2)$adjr2
summary(nyc.fwd2)$rss
summary(nyc.fwd2)$bic
```

```{r backward selection model}
nyc.bck = regsubsets(lprice~neighbourhood_group + room_type + neighbourhood_group:room_type + minimum_nights + number_of_reviews + calculated_host_listings_count + minimum_nights:number_of_reviews + minimum_nights:calculated_host_listings_count + number_of_reviews:calculated_host_listings_count, data=log.nyc.outliers, method="backward",nvmax=20)
summary(nyc.bck)$adjr2
summary(nyc.bck)$rss
summary(nyc.bck)$bic
```

```{r exhaustive selection model}
nyc.exh = regsubsets(lprice~neighbourhood_group + room_type + neighbourhood_group:room_type + minimum_nights + number_of_reviews + calculated_host_listings_count + minimum_nights:number_of_reviews + minimum_nights:calculated_host_listings_count + number_of_reviews:calculated_host_listings_count, data=log.nyc.outliers, method="exhaustive",nvmax=20)
summary(nyc.exh)$adjr2
summary(nyc.exh)$rss
summary(nyc.exh)$bic
```

```{r seqrep selection model}
nyc.seq = regsubsets(lprice~neighbourhood_group + room_type + neighbourhood_group:room_type + minimum_nights + number_of_reviews + calculated_host_listings_count + minimum_nights:number_of_reviews + minimum_nights:calculated_host_listings_count + number_of_reviews:calculated_host_listings_count, data=log.nyc.outliers, method="seqrep",nvmax=20)
summary(nyc.exh)$adjr2
summary(nyc.exh)$rss
summary(nyc.exh)$bic
```

#### Assumptions Check
- Risduals are normally distributed
  - Log-linear model has closest to normally distrubuted residuals from last plot
  - Near normal distriution of residuals
  - Envoking Central Limit Theorum due to such a large sample size
- Constant variance
  - Near normal QQ-plot

```{r residuals, constant variance assumption}
par(mfrow=c(2,2))
plot(log.nyc.outliers.model)
```

- Independence
  - Assumed
- Multicollinearity
  - Confirmed with VIFs and pairs plot that there is no mjultcollinearity occuring

```{r multicollinearity assumption two}
vif(log.depend.model)[,3]^2
```

```{r multicollinearity assumption}
pairs(log.nyc.outliers, col=log.nyc.outliers$neighbourhood_group) #Color by neighborhood
```

- Removed all prices over 400 to help reduce data set and uncover any correlation that was present between the dependent varaibles and independent categorical variables

```{r outliers assumption}
#log.nyc.outliers <- log.nyc[!(log.nyc$lprice > 400),]
```

#### MLR May Not Be The Best
- Multiple linear regression is just one option in building a predictive model for a continuous response
- We are seeing it as a bad option because
  - The true relationship between the response and predictors is NOT “linear”.  The relationships are complex.
    - We have gotten close, but we have worked extremely hard in specifying our model and manipulating the raw data to surface a linear relationship
    - This makes the interpretation into the real world application difficult to interpret
  - Since the above is true and our data is very large, we think that other methods such as Random Forest or K-NN would perform better.
    - These options are less time consuming because the model complexity is built into the lagorithm
    - We also do not have to specify how a relationship exists ahead of time
- Since we see a strong relationship between the categorical variables, we move forward with a Two-Way ANOVA model to create a model way predict the price of a NYC AirBnB.