---
title: "MSDS 6372 Project 1 Objective 2"
author: "Jaclyn A Coate"
date: "1/22/2020"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r libraries}
library(tidyverse)
library(mice)
library(skimr)
library(corrplot)
library(car)
library(ISLR)
library(ggplot2)
library(gridExtra)
```

# Objective 1:
## Question of Interest: what variables are used to predict price of a NYC Airbnb

```{r data prep}
nycraw <- read.csv("https://raw.githubusercontent.com/JaclynCoate/6372_Project/master/AB_NYC_2019.csv", header = TRUE, strip.white=TRUE)
head(nycraw)
str(nycraw)
```

## EDA to determine type of multiple linear regression to perform

#### Removing logically irrelevant variables

```{r drop irrelevant variables}
#Dropping logical irrelevant variables: "id", "name", "host_id", "host_name", "last_reiview", "latitude", "longitude", "neighborhood","availability_365"
nyc2 <- select(nycraw, -c("id", "name", "host_id", "host_name", "last_review", "latitude", "longitude", "neighbourhood","availability_365"))
head(nyc2)
```

#### Dependent Variable Check
- Checking on dependent variable range to make sure if there are zero's to remove. It would not be free to stay in NYC.
```{r}
nyc2 <- nyc2[!(nyc2$price==0),]
invisible(view(nyc2))
```

#### NA Evaluation and Drop

```{r NA eval}
#Checking for NAs
md.pattern(nyc2)
nrow(nyc2)
#Drop NAs that are present
nyc3 <- na.omit(nyc2)
#Confirming NA drop
nrow(nyc3)
```

#### Zero variance variable check - all show variance so remain in model

```{r zero variable check}
#Results show no zero variance variables, leave in all
skim(nyc3)
```

#### Storing all categorical variables as factors

```{r categorical as factors}
#Storing categorical variables as factors
skim(nyc3)
```

#### Checking for Multicollinearity
- Multicollinearity will weaken the model
  - number_of_reviews and reviews_per_month are correlated at 55%
    - Removing reviews_per_month

```{r multicollinearity1}
corrNYC <- nyc3
#Table numeric variables
corrNYCTable <- corrNYC %>% keep(is.numeric) %>% cor %>% view
#Plot numeric variables v numeric variables
corrNYC %>% keep(is.numeric) %>% cor %>% corrplot("upper", addCoef.col = "white", number.digits = 2, number.cex = 0.5, method="square", order="hclust", tl.srt=45, tl.cex = 0.8)
invisible(view(corrNYCTable))
```

```{r attrition: removing highly correlated variable}
#Removing reviews_per_month due to high correlation of is and number_of_reviews
nyc4 <- select(nyc3, -c("reviews_per_month"))
```

#### Summary Review of Data Set

```{r}
summary(nyc4)
```

#### Removing outliers from minimum nights stay
- Anything over 365 is more than a year and would be improbable
- Removing any minimum nights metric over 365

```{r}
nyc4 <- nyc4[!(nyc4$minimum_nights > 365),]
invisible(view(nyc4))
```

#### Examining VIFs
- The below results show us there is no need to remove any variables

```{r}
full.model<-lm(price~.,data=nyc4)  # . means all variable not mpg
vif(full.model)[,3]^2

alias(lm(price~.,data=nyc4))
```

# Question 2

## 2-Way ANOVA Analysis
- In completing this project with the tools learned in Unit 3 - we will perform a 2-Way ANOVA analysis.

```{r drop numeric values}
nyc.anova <- nyc4 %>% select(-c("number_of_reviews", "calculated_host_listings_count", "minimum_nights"))
head(nyc.anova)
invisible(view(nyc.anova))
```

#### Unbalanced Data
- In reviewing the data we see unbalanced data between the Shared room, Private room, and Entire home/apt indepednet variable levels
- Comapring a shared room leve to a private room or home seems logically irrelevent
- Removing shared room variable
- By removing this leve this model will no longer used for a shared room level of the room_type variable
  - Include this in the conclusion/caveat in scope of inference

```{r}
#Reviewing data levels of room_types
nyc.home <- nyc.anova[(nyc.anova$room_type=="Entire home/apt"),]
nrow(nyc.home)

nyc.private <- nyc.anova[(nyc.anova$room_type=="Private room"),]
nrow(nyc.private)

nyc.shared <- nyc.anova[(nyc.anova$room_type=="Shared room"),]
nrow(nyc.shared)
```

```{r}
#Making final data set with only Private room & Entire home/apt
nyc.anova <- nyc.anova[!(nyc.anova$room_type=="Shared room"),]
invisible(nyc.anova)
```

#### Summary Statistics Table
- Creating Mean, SD, SE, Min, Max, and IQR
- Table of graphable statistics

```{r attach data create function sumstats table}
#Attaching the data set
attach(nyc.anova)
#Creating a function
nycsummary<-function(x){
  result<-c(length(x),mean(x),sd(x),sd(x)/sqrt(length(x)), min(x), max(x), IQR(x))
  names(result)<-c("N","Mean","SD","SE","Min","Max","IQR")
  return(result)
}
#Creating a summary stats table
nycsumstats<-aggregate(price~neighbourhood_group*room_type,data=nyc.anova,nycsummary)
nycsumstats<-cbind(nycsumstats[,1:2],nycsumstats[,-(1:2)])
nycsumstats
```

#### Summary Statistics Graph
#- The below graph shows characteristics of a nonadditive model
#- Next Steps:
#  1. Fit a non-additive model
#  2. Check the assumptions
#  3. Exmine Type III Sum of Squares F-test tables

```{r sumstats graph}
ggplot(nycsumstats,aes(x=room_type,y=Mean,group=neighbourhood_group,colour=neighbourhood_group))+
  ylab("NYC AirBnBs Prices")+xlab("Room Type")+
  geom_line()+
  geom_point()+
  geom_errorbar(aes(ymin=Mean-SD,ymax=Mean+SD),width=.1)
```

#### Nonadditive 2-Way ANOVA
- QQ Plot for assumption assessment
  - Show a curve, needs transformation
  
```{r nonadditive model fit}
#The following code fits the nonadditive two way anova model and then produces the first the main residual diagnostics for assumption checking
nyc.model.fit<-aov(price~neighbourhood_group+room_type+neighbourhood_group:room_type,data=nyc.anova)

nyc.fits <- data.frame(fitted.values=nyc.model.fit$fitted.values,residuals=nyc.model.fit$residuals)

#Reisudals vs Fitted
nyc.plot1 <- ggplot(nyc.fits, aes(x=fitted.values,y=residuals))+ylab("Residuals")+
  xlab("Predicted")+geom_point()
#QQ Plot of residuals #Note the diagonal abline is only good for qqplots of normal data
nyc.plot2 <- ggplot(nyc.fits,aes(sample=residuals))+
  stat_qq()+geom_abline(intercept=mean(nyc.fits$residuals), slope = sd(nyc.fits$residuals))
#Histograms of residuals
nyc.plot3 <- ggplot(nyc.fits, aes(x=residuals)) + 
  geom_histogram(aes(y=..density..),binwidth=1,color="black", fill="gray")+
  geom_density(alpha=.1, fill="red")
#Grid of all 3 graphs above
grid.arrange(nyc.plot1, nyc.plot2, nyc.plot3, ncol=3)
```

#### Log transformation on price

```{r log transformation on price}
#Cannot log zero values, must remove from price variable
nyc.anova <- nyc.anova[!(nyc.anova$price == 0),]
#Auto3 <- Auto[!(Auto$cylinders == 3),]
#Transforming price to logged variable
nyc.log.anova <- nyc.anova %>% mutate(lprice=log(price))
#view(nyc.final)
```

#### Assumptions check on log transformation of price
- Equal variances: there is some slight variation of variances but this will suffice in order to move forward
- QQ Plot: there is still some slight departure from normality, but again this is acceptable to move forward with our model
- DON'T FORGET TO MENTION CLT - Central Limit Theorum

```{r assumptions on log price}
nyc.model.fit.log<-aov(lprice~neighbourhood_group+room_type+neighbourhood_group:room_type,data=nyc.log.anova)

nyc.fits.log <- data.frame(fitted.values=nyc.model.fit.log$fitted.values,residuals=nyc.model.fit.log$residuals)

#Reisudals vs Fitted
nyc.logplot1 <- ggplot(nyc.fits.log, aes(x=fitted.values,y=residuals))+ylab("Residuals")+
  xlab("Predicted")+geom_point()
#QQ Plot of residuals #Note the diagonal abline is only good for qqplots of normal data
nyc.logplot2 <- ggplot(nyc.fits.log,aes(sample=residuals))+
  stat_qq()+geom_abline(intercept=mean(nyc.fits.log$residuals), slope = sd(nyc.fits.log$residuals))
#Histograms of residuals
nyc.logplot3 <- ggplot(nyc.fits.log, aes(x=residuals)) + 
  geom_histogram(aes(y=..density..),binwidth=1,color="black", fill="gray")+
  geom_density(alpha=.1, fill="red")
#Grid of all 3 graphs above
grid.arrange(nyc.logplot1, nyc.logplot2, nyc.logplot3, ncol=3)
```

#### Outliers
- Since there are not singular points that are aggressively skewing the data, these outliers aren't considered unique or affecting the model in a way that would not be logical.
- Choose to leave all low and high end metrics since the model should take these into account

#### Type III F-test table
- From the below F-test table we can see that neighborhood_group, room_type, as well as their interaction are all statistically significant for this model
- The type-3 sums of squares F-test is provided below. The test for an interaction is not significant (F-stat: 12.493 p-value < .0001). Therefore, we can conclude that the potential changes in AirBnB price for one of the factors does depend on the other.

```{r}
Anova(nyc.model.fit.log,type=3)
```

#### Multiple Test Technique: Tukey-Kramer
- From the F-test table we can see that all current variables are statistically significnat at the 0.05 alpha level
- Move forward with the Tukey-Kramer to discover what factors and/or combinations contribute to predicting the price of a NYC AirBnB

```{r}
nyc.anova.diff <- TukeyHSD(nyc.model.fit.log,"neighbourhood_group:room_type", conf.level = .95)
nyc.anova.diff
```

```{r}
plot(TukeyHSD(nyc.model.fit.log,"neighbourhood_group:room_type", conf.level = .95))
```