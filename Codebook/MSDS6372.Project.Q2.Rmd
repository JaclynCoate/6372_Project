---
title: "MSDS 6372 Project"
author: "Jaclyn A Coate"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r libraries}
library(tidyverse)
library(mice)
library(skimr)
library(corrplot)
library(car)
library(ISLR)
library(ggplot2)
```

# Question 1:
## Question of Interest: what variables are used to predict price of a NYC Airbnb

```{r data prep}
nycraw <- read.csv("https://raw.githubusercontent.com/JaclynCoate/6372_Project/master/AB_NYC_2019.csv", header = TRUE, strip.white=TRUE)
head(nycraw)
str(nycraw)
```

## EDA to determine type of multiple linear regression to perform

#### Removing logically irrelevant variables

```{r drop irrelevant variables}
#Dropping logical irrelevant variables: "id", "name", "host_id", "host_name", "last_reiview", "latitude", "longitude", "neighborhood","availability_365"
nyc2 <- select(nycraw, -c("id", "name", "host_id", "host_name", "last_review", "latitude", "longitude", "minimum_nights", "neighbourhood","availability_365"))
head(nyc2)
```

#### NA Evaluation and Drop

```{r NA eval}
#Checking for NAs
md.pattern(nyc2)
nrow(nyc2)
#Drop NAs that are present
nyc3 <- na.omit(nyc2)
#Confirming NA drop
nrow(nyc3)
```

#### Zero variance variable check - all show variance so remain in model

```{r zero variable check}
#Results show no zero variance variables, leave in all
skim(nyc3)
```

#### Storing all categorical variables as factors

```{r categorical as factors}
#Storing categorical variables as factors
skim(nyc3)
```

#### Checking for Multicollinearity
- Multicollinearity will weaken the model
  - number_of_reviews and reviews_per_month are correlated at 55%
    - Removing reviews_per_month

```{r multicollinearity1}
corrNYC <- nyc3
#Table numeric variables
corrNYCTable <- corrNYC %>% keep(is.numeric) %>% cor %>% view
#Plot numeric variables v numeric variables
corrNYC %>% keep(is.numeric) %>% cor %>% corrplot("upper", addCoef.col = "white", number.digits = 2, number.cex = 0.5, method="square", order="hclust", tl.srt=45, tl.cex = 0.8)
invisible(view(corrNYCTable))
```

```{r attrition: removing highly correlated variable}
#Removing reviews_per_month due to high correlation of is and number_of_reviews
nyc4 <- select(nyc3, -c("reviews_per_month"))
```

#### Summary Review of Data Set

```{r}
summary(nyc4)
```

#### Examining VIFs
- The below results show us there is no need to remove any variables

```{r}
full.model<-lm(price~.,data=nyc4)  # . means all variable not mpg
vif(full.model)[,3]^2

alias(lm(price~.,data=nyc4))
```

## **EDA COMPLETE**

#### Reviewing Linearity with Numeric Variables
- Curved relationships with the numeric variables
  - Could require a quadratic or logarithmic transformation

```{r linearity check}
nyc4 %>% keep(is.numeric) %>% pairs()

par(mfrow=c(2,2))
plot(full.model)
```

```{r drop numeric values}
nyc.final <- nyc4 %>% select(-c("number_of_reviews", "calculated_host_listings_count"))
head(nyc.final)
```

# **** MOVE FORWARD WITH LOG TRANFORAMTIONS / QUADRATIC TRANFORMATIONS TO FIND PREDICTION MODEL WITH NUMERIC VARIABLES FOR QUESTION! ****
#### XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

# Question 2

## 2-Way ANOVA Analysis
- In completing this project with the tools learned in Unit 3 - we will choose to walk away from log transformation and perform a 2-Way ANOVA analysis in order for accuracy as well as simplicity of interpretation of coefficients.

#### Summary Statistics Table
- Creating Mean, SD, SE, Min, Max, and IQR
- Table of graphable statistics

```{r attach data create function sumstats table}
#Attaching the data set
attach(nyc.final)
#Creating a function
nycsummary<-function(x){
  result<-c(length(x),mean(x),sd(x),sd(x)/sqrt(length(x)), min(x), max(x), IQR(x))
  names(result)<-c("N","Mean","SD","SE","Min","Max","IQR")
  return(result)
}
#Creating a summary stats table
nycsumstats<-aggregate(price~neighbourhood_group*room_type,data=nyc.final,nycsummary)
nycsumstats<-cbind(nycsumstats[,1:2],nycsumstats[,-(1:2)])
nycsumstats
```

#### Summary Statistics Graph
- The below graph shows characteristics of a nonadditive model
- Next Steps:
  1. Fit a non-additive model
  2. Check the assumptions
  3. Exmine Type III Sum of Squares F-test tables

```{r sumstats graph}
#means profile plot to visualize the sumstats above
ggplot(nycsumstats,aes(x=neighbourhood_group,y=Mean,group=room_type,colour=room_type))+
  ylab("NYC AirBnBs Prices")+
  geom_line()+
  geom_point()+
  geom_errorbar(aes(ymin=Mean-SD,ymax=Mean+SD),width=.1)

ggplot(nycsumstats,aes(x=room_type,y=Mean,group=neighbourhood_group,colour=neighbourhood_group))+
  ylab("NYC AirBnBs Prices")+
  geom_line()+
  geom_point()+
  geom_errorbar(aes(ymin=Mean-SD,ymax=Mean+SD),width=.1)
```

#### Nonadditive 2-Way ANOVA
- QQ Plot for assumption assessment
  - Show a curve, needs transformation
```{r nonadditive model fit}
#The following code fits the nonadditive two way anova model and then produces the first the main residual diagnostics for assumption checking
nyc.model.fit<-aov(price~neighbourhood_group+room_type+neighbourhood_group:room_type,data=nyc.final)
par(mfrow=c(1,2))
plot(nyc.model.fit$fitted.values,nyc.model.fit$residuals,ylab="Resdiduals",xlab="Fitted")
qqnorm(nyc.model.fit$residuals)
```

#### Log transformation on price

```{r log transformation on price}
#Cannot log zero values, must remove from price variable
nyc.final <- nyc.final[!(nyc.final$price == 0),]
#Auto3 <- Auto[!(Auto$cylinders == 3),]
#Transforming price to logged variable
nyc.log <- nyc.final %>% mutate(lprice=log(price))
view(nyc.log)
```

#### Assumptions check on log transformation of price
- Equal variances: there is some slight variation of variances but this will suffice in order to move forward
- QQ Plot: there is still some slight departure from normality, but again this is acceptable to move forward with our model

```{r assumptions on log price}
nyc.model.fit.log<-aov(lprice~neighbourhood_group+room_type+neighbourhood_group:room_type,data=nyc.log)

par(mfrow=c(1,2))
plot(nyc.model.fit.log$fitted.values,nyc.model.fit.log$residuals,ylab="Resdiduals",xlab="Fitted")
qqnorm(nyc.model.fit.log$residuals)
```

#### Type III F-test table
- From the below F-test table we can see that neighborhood_group, room_type, as well as their interaction are all statistically significant for this model

```{r}
Anova(nyc.model.fit.log,type=3)
```

#### Multiple Test Technique: Tukey-Kramer
- From the F-test table we can see that all current variables are statistically significnat at the 0.05 alpha level
- Move forward with the Tukey-Kramer to discover what factors and/or combinations are contribute to predicting the price of a NYC AirBnB

```{r}
TukeyHSD(nyc.model.fit.log,"neighbourhood_group:room_type", conf.level = .95)
plot(TukeyHSD(nyc.model.fit.log,"neighbourhood_group:room_type", conf.level = .95))
```

```{r}

```